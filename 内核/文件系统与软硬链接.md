[TOC]

# 文件系统与软硬链接

## 一、硬盘

硬盘分为**固态硬盘**与**机械硬盘**，其中机械硬盘相对容量大且价格便宜，所以在服务器中应用广泛。

### 1、固态硬盘(Solid State Disk, SSD)

固态硬盘是一种基于**闪存**的存储技术。它的读写速度取决于闪存芯片的性能，一般比机械硬盘快**4~20倍**。

### 2、机械硬盘(Hard Disk Drive, HDD)

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307599.jpg) 

**磁盘**是机械硬盘的存储介质。一个磁盘的上下表面称为**盘面**，盘面上覆盖着**磁性记录材料**。

每个盘面都对应一个**磁头**用来读写：

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307611.jpg) 

 

磁盘的盘面是由一组称为**磁道**的同心圆组成的，每个磁道被划分为一组扇区，**每个扇区存储相同数量的数据位**，通常为**512字节**(内外磁道的**磁性记录材料密度不同**)。

扇区与扇区之间的空隙用来存储标识扇区的**格式化信息**。

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307620.jpg) 

每个盘面拥有相同数量的磁道，将它们从内向外编号，那么**所有盘面中相同编号的磁道**将构成一个**柱面**：

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307628.jpg) 

#### I.磁盘容量公式

> 盘面数 × 每个盘面的磁道数 × 每个磁道的扇区数 × 扇区大小

## 二、文件系统

### 1、机械硬盘的分块管理

为了方便操作系统管理，现代磁盘的复杂构造被简化为由B个扇区大小的逻辑块构成的序列，编号为0~B-1。

每个逻辑块的编号可以被**磁盘控制器**翻译成==*(盘面，磁道，扇区)*==的三元组，经过盘面和磁头的旋转(**寻道**)，完成对实际磁盘物理位置的读写。

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307640.jpg) 

### 2、ext系列文件系统

事实上，内核在读写硬盘数据时，一次性最少读写一个**块(Block)**。默认一个块的大小为**4KB**，即8个扇区大小的逻辑块。

文件被存储在块(Block)中，由内核的文件管理系统对这些块进行统一的管理，以ext系列文件系统为例：

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307655.jpg) 

#### I.块信息

- 引导块用来存储磁盘分区信息和启动信息，任何文件系统不得修改该块的内容。

- 组块0~n拥有相同的结构：

  1. 超级块：描述当前组块的信息，如inode数量及大小、数据块数量及大小；

  2. 组块描述表：描述当前组块的各部分起始位置，如块位图起始位置；

  3. 块位图：记录数据块的区块的使用情况；

  4. inode位图：记录inode的使用情况；

  5. inode表：表中的每一个inode记录了对应文件<font color=red>**除了文件名以外的所有属性信息**</font>，如大小、读写权限、`atime、mtime、ctime`等。此外，inode还会记录**文件所在的区块**。

     注：每个inode都对应一个inode号码，可以理解为inode表中的索引。

  6. 数据块：文件数据存储的地方，每个数据块被分成许多小的**区块**，一个区块只能存储一个文件的数据，其使用情况存储在块位图中。如果==文件大于区块大小==，则该文件占用多个区块；如果==文件小于区块大小==，则区块剩余容量不再使用。

#### II.目录与映射表

当创建一个目录文件时，ext文件系统会分配**一个inode**和**至少一个数据区块**给该目录。其中，inode存储该目录的属性和对应数据区块；数据区块则存储了该目录下的<font color=red>**文件名和inode号码的一一映射关系**</font>(正因如此，一个目录下不允许出现同名文件)。

#### III.属性、数据的分离

ext文件系统利用<font color=red>**inode存储文件属性**，**数据区块存储文件数据**</font>，做到了属性与数据的分离存储。

#### IV.文件的三个时间

文件的三个时间是文件的属性信息，其具体内涵为：

1、`atime`(access time)：访问时间，即最近一次==读取该文件的时间==；

2、`mtime`(modify time)：修改时间，即最近一次==修改文件内容的时间==；

3、`ctime`(change time)：状态改动时间，即最近一次==修改文件属性的时间==，包括文件名、文件大小、文件权限、文件所有者等属性信息。

使用`touch 文件名`命令可以将目标文件的三个时间修改为当前系统的时间。

使用`stat`命令**查看文件的属性**，其中包括三个时间、inode号码和链接数等信息：

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307671.jpg) 

####  V.进程与文件

**删除文件**

删除文件实际上只是在当前目录中删除该文件的名字与inode的映射关系，但是文件的数据以及*inode*并不会立即被删除。

因此，若进程已经打开文件，则文件被删除并不会影响进程的操作，因为进程已经具备文件的描述信息。

**读写文件**

内核为进程打开的文件都维护了独立的信息，如：文件打开状态、当前文件偏移量、文件的fd等。

因此，不同进程读文件，并不会相互冲突；但是操作系统不会保证多个进程一起写文件的原子性。

## 三、软硬链接与ln命令

### 1、硬链接

> 硬链接相当于一个文件的**别名**。在创建时，文件系统不会为它分配独立的inode，而是让该文件的inode与链接文件相同。
>
> 因此，硬链接文件与原文件**只有名字上的不同**，实际上指向的是同一份文件。

硬链接命令： `ln 原文件名 链接文件名`

#### I.普通文件

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307664.jpg) 

一个普通文件的初始链接数为1(即文件本身)，当创建硬链接时，链接数变为2，且链接文件与原文件的inode相同。

#### II.目录

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307670.jpg) 

一个目录的初始链接数为2，进入到该目录可以发现两个默认目录：`.和..`。

`.`是<font color=red>**当前目录的硬链接**</font>，再加上目录本身，所以初始链接为2。

如果在当前目录下再创建新目录，就会导致链接数加1，因为每一个新目录都有`..`，它是<font color=red>**上一级目录的硬链接**</font>。

### 2、软链接

软链接相当于一个文件的快捷方式。在创建时，文件系统会为它分配**独立的inode**，但是<font color=red>**仅存储链接文件的路径信息**</font>，**不存储有效数据**。

软链接命令：`ln -s 原文件名 链接文件名`

![img](https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208071307672.jpg) 

原文件和软链接文件的inode不同，且创建软链接文件不会导致链接数增加。

3、补充：跨文件系统问题

> 一个磁盘上的不同分区可能会使用不同的文件系统。

硬链接不可以跨文件系统，因为不同文件系统对应的inode可能是不同的，

软链接可以跨文件系统，因为软链接拥有独立的inode，且存储的是链接文件的路径。

 ###  3、补充：跨文件系统问题

> 一个磁盘上的不同分区可能会使用不同的文件系统。

硬链接**不可以跨文件系统**，因为硬链接与链接文件拥有相同的inode，但是不同文件系统下对应的inode可能是不同的。

软链接**可以跨文件系统**，因为软链接拥有独立的inode，且存储的是链接文件的路径。

 