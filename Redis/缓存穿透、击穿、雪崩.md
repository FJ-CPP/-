[TOC]

# 缓存问题

## 一、Redis如何做缓存

常见的关系型数据库如MySQL对于大量并发请求的处理效率是很低的，因此可以使用Redis作为用户请求和数据库服务器之间的缓存。

- 请求优先查询Redis服务器的缓存数据，如果命中则直接返回，不必再向MySQL服务器请求。
- 如果没有命中Redis缓存，再向数据库进行数据查询，同时将数据写入缓存。

这种模式极大地提高了查询效率，减轻了数据库服务器的压力，但是依然会引发三种常见的缓存问题：缓存穿透、击穿和雪崩。

<img src="https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208181906379.png" alt="image-20220818190601299" style="zoom:80%;" />



## 二、缓存穿透

> 缓存穿透：用户查询的数据**既不在Redis缓存，又不在数据库中**，而查询不到的数据不会被放入缓存。
>
> 因此如果有大量请求查询不存在的数据，此时数据库服务器就可能因为要并发接受大量请求而崩溃。

<img src="https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208181910491.png" alt="image-20220818191046456" style="zoom:80%;" />

### 解决方案

1. 验证拦截。比如：请求的数据id不允许小于0，则在请求前先将小于0的拦截掉。
2. 将空值缓存下来，并设置过期时间(不宜过长，一般三五分钟即可)。如果下次用户依旧查询不存在的数据，则直接返回缓存中的空值。
3. 将数据库服务器中的数据映射到布隆过滤器中。请求优先到布隆过滤器中查看数据是否存在，如果不存在，则返回空值。缺点就是有误差，而且将所有数据映射下来，时间成本较高。

> 注：布隆过滤器如果告知数据不存在，则数据一定不存在，但是告知存在的数据可能是不存在的。



## 三、缓存击穿

> 缓存击穿：某一份热点数据过期，而此时又恰好有大量请求它，那么这些请求会直接击穿缓存到达数据库服务器，从而使其崩溃。

<img src="https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208181912127.png" alt="image-20220818191217094" style="zoom:80%;" />

### 解决方案

1. 设置热点数据永不过期。
2. 设置逻辑过期时间：异步线程检查过期键，将其更新为最新数据后再次设置新的过期时间。
3. 加互斥锁：当一个线程击穿缓存，去数据库访问时，它使用互斥锁将数据库锁住，此时其它线程由于得不到锁而进入短暂休眠，然后重新请求缓存。当击穿缓存的线程获取数据返回时，将数据写入缓存，同时释放锁，之后其他线程就可以直接从缓存获取数据。



## 四、缓存雪崩

> 缓存雪崩：当Redis发生故障无法提供服务，或是大量数据在一个时间段同时过期，那么就会有大量请求涌入数据库服务器，致使其崩溃。

<img src="https://typora-1307604235.cos.ap-nanjing.myqcloud.com/typora_img/202208181914229.png" alt="image-20220818191405193" style="zoom:80%;" />

### 解决方案

1. 避免数据同时过期：给数据的过期时间后再追加一个随机数。
2. 构建高可用的Redis服务：采用**哨兵或集群**模式，部署多个Redis实例。如果个别节点宕机，Redis依然可以保持服务的整体可用。









