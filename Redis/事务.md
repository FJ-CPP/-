[TOC]

# 事务

Redis通过`MULTI、EXEC、DISCARD、WATCH`等命令来实现事务的功能。

- `MULTI`用来开启一个事务，接下来的多个命令都会被放到事务中，直到使用`EXEC`进行提交执行。
- 如果发现事务中有语句错误，则可以使用`DISCARD`将整个事务丢弃。
- `WATCH`是一个乐观锁，用于**在事务开启前**监视数据库中的任意多个键，并**在事务提交前**检查这些键是否被其他事务修改，如果是，则服务器回复*nil*，表示事务执行失败。

> 注：Redis如果在事务中使用`MULTI`则会报错，而MySQL在事务中使用`BEGIN`则会提交上一事务。

## 1、事务的原理

### I.  命令入队

当使用`MULTI`开启一个事务后，服务器会根据客户端发过来的不同命令执行不同的操作：

- 如果是`MULTI、EXEC、DISCARD、WATCH`，则该命令立即执行。
- 如果是其他命令，则命令被放入一个**事务队列**，同时服务器向客户端回复*QUEUED*。

> 注：
>
> - 对于一些简单的语法错误，比如命令不存在，或命令的格式不正确，那么**服务器会检查出来并直接终止当前事务**。
> - 但是对于其它错误，比如给字符串执行`incr`操作，则只有提交后才能检查出来，在这种情况下服务器不会中断整个事务，而是正常执行其他命令。

### II. WATCH命令的实现

1. 服务器维护一个`watched_keys`字典，字典的键是某个被`WATCH`命令监视的数据库键，值是一个链表，用来记录监视这些数据库键的客户端有哪些。
2. 所有对数据库修改的命令，如`SET/SADD`等，服务器都会**检查是否有客户端正在监视对应的键**。如果有，则将这些数据库的`REDIS_DIRTY_CAS`标识符打开，表示该客户端的事务安全性已被破坏。
3. 当客户端使用`EXEC`提交事务时，服务器会检查它的`REDIS_DIRTY_CAS`是否被打开，如果是，则取消该事务的执行，同时返回*nil*。

### III. 执行事务

当客户端发送`EXEC`命令时，服务器会遍历事务队列，执行所有命令并将**执行成功或失败**的结果返回给客户端。

此外，在返回前还会清除该客户端曾经`WATCH`的键列表。

## 2、事务的ACID特性

- **原子性：**事务中的命令要么全部被执行，要么一个都不执行。
- **一致性：**Redis通过错误检测等方式**避免出现非法数据**。
- **隔离性：**Redis以单线程的方式执行事务，且执行过程不会被中断，因此事务的执行总是**串行化**的，即指令按顺序一条一条执行。
- **持续性：**由Redis持久化策略(*RDB*和*AOF*)保证。







